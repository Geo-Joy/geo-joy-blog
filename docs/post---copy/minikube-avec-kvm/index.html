<!DOCTYPE html>
<html lang="en-us" class="wf-loading">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />

        <meta name="HandheldFriendly" content="True" />
        <meta name="MobileOptimized" content="320" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <link rel="preload" href="http://geojoy.me/js/main.js" as="script" />
        <link rel="preload" href="http://geojoy.me/css/main.css" as="style" />

        <title>Kubernetes Minikube avec KVM</title>
        <meta name="generator" content="Hugo 0.32.4" />
        
        <link rel="preconnect" href="https://ajax.googleapis.com/" crossorigin>
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
        <meta property="og:title" content="Kubernetes Minikube avec KVM" />
<meta property="og:description" content="Déployer Kubernetes en version locale sous Archlinux avec KVM." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://geojoy.me/post---copy/minikube-avec-kvm/" />



<meta property="article:published_time" content="2017-03-24T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2017-03-28T20:05:06&#43;02:00"/>











    
        <meta property="og:type" content="article" />
        <meta property="og:article:published_time" content="2017-03-24T00:00:00Z" />
        <meta property="og:article:tag" content="linux" />
        <meta property="og:article:tag" content="kubernetes" />
        <meta property="og:article:tag" content="docker" />
        <meta property="og:article:tag" content="devops" />
        <meta property="og:article:tag" content="golang" />
        
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@megeojoy" />
        <meta name="twitter:creator" content="@megeojoy" />
        <meta name="twitter:title" content="Kubernetes Minikube avec KVM" />
        <meta name="twitter:description" content="Déployer Kubernetes en version locale sous Archlinux avec KVM." />
        <meta name="twitter:url" content="http://geojoy.me/post---copy/minikube-avec-kvm/" />
        <meta name="twitter:image" content="http://geojoy.me/images/articles/2017/kubernetes.png">
    

    
        <meta name="p:domain_verify" content="58lHJFznHgioHOIv2NvLfobc8XEUUZSKm016uFFO4vE"/>
    

    
    <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "Geo Joy",
      "url": "http://geojoy.me",
      "sameAs": [
        "https://twitter.com/megeojoy",
        "https://www.linkedin.com/in/geojoy/",
        "https://github.com/Geo-Joy",
      ],
      "image": {
        "@type": "ImageObject",
        "url": "https://geojoy.me/images/avatar.jpg",
        "height": 80,
        "width": 80
      }
    }
    </script>

    <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Organization",
      "@id": "http://geojoy.me",
      "name": "Geo&#39;z Blog",
      "url": "http://geojoy.me",
      "logo": {
        "@type": "ImageObject",
        "url": "https://geojoy.me/images/avatar.jpg",
        "height": 80,
        "width": 80
      }
    }
    </script>

    <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "WebSite",
      "url": "http://geojoy.me",
      "name": "Geo&#39;z Blog",
      "author": {
        "@type": "Person",
        "name": "Geo Joy"
      },
      "description": ""
    }
    </script>

      
      <script type="application/ld+json">
      {
          "@context": "http://schema.org",
          "@type": "BlogPosting",
          "headline": "Kubernetes Minikube avec KVM",
          "description": "Déployer Kubernetes en version locale sous Archlinux avec KVM.",
          "author": {
              "@type": "Person",
              "name": "Geo Joy"
          },
          "publisher": {
              "@type": "Organization",
              "name": "Geo&#39;z Blog",
              "logo": "https://geojoy.me/images/avatar.jpg"
          },
          "image": {
            "@type": "ImageObject",
            "url": "http://geojoy.me/images/articles/2017/kubernetes.png",
            "height": 133,
            "width": 200
          },
          "datePublished": "2017-03-24",
          "dateModified": "2017-03-28",
          "wordCount": 1162
          ,
          "keywords": ["linux","kubernetes","docker","devops","golang"] 
      }
    </script>
  

    <style>
body{margin:0}main,nav{display:block}a{background-color:transparent}h1{margin:.67em 0;font-size:2em}img{border:0}code,kbd{font-family:monospace,monospace;font-size:1em}button{margin:0;font:inherit;color:inherit}button{overflow:visible}button{text-transform:none}button{-webkit-appearance:button}button::-moz-focus-inner{padding:0;border:0}*{-webkit-box-sizing:border-box;box-sizing:border-box}:after,:before{-webkit-box-sizing:border-box;box-sizing:border-box}html{font-size:10px}body{font-family:"Raleway",Helvetica,Arial,sans-serif;font-size:14px;line-height:1.42857143;color:#333;background-color:#fff}button{font-family:inherit;font-size:inherit;line-height:inherit}a{color:#337ab7;text-decoration:none}img{vertical-align:middle}h1,h4,h5{font-family:inherit;font-weight:500;line-height:1.1;color:inherit}h1{margin-top:20px;margin-bottom:10px}h4,h5{margin-top:10px;margin-bottom:10px}h1{font-size:36px}h4{font-size:18px}h5{font-size:14px}p{margin:0 0 10px}.text-justify{text-align:justify}ul{margin-top:0;margin-bottom:10px}blockquote{padding:10px 20px;margin:0 0 20px;font-size:17.5px;border-left:5px solid #eee}blockquote p:last-child{margin-bottom:0}code,kbd{font-family:Menlo,Monaco,Consolas,"Courier New",monospace}code{padding:2px 4px;font-size:90%;color:#c7254e;background-color:#f9f2f4;border-radius:4px}kbd{padding:2px 4px;font-size:90%;color:#fff;background-color:#333;border-radius:3px;-webkit-box-shadow:inset 0 -1px 0 rgba(0,0,0,.25);box-shadow:inset 0 -1px 0 rgba(0,0,0,.25)}.container{padding-right:15px;padding-left:15px;margin-right:auto;margin-left:auto}@media (min-width:768px){.container{width:750px}}@media (min-width:992px){.container{width:970px}}@media (min-width:1200px){.container{width:1170px}}.collapse{display:none}.nav{padding-left:0;margin-bottom:0;list-style:none}.nav>li{position:relative;display:block}.nav>li>a{position:relative;display:block;padding:10px 15px}.navbar{position:relative;min-height:50px;margin-bottom:20px;border:1px solid transparent}@media (min-width:768px){.navbar{border-radius:4px}}@media (min-width:768px){.navbar-header{float:left}}.navbar-collapse{padding-right:15px;padding-left:15px;overflow-x:visible;-webkit-overflow-scrolling:touch;border-top:1px solid transparent;-webkit-box-shadow:inset 0 1px 0 rgba(255,255,255,.1);box-shadow:inset 0 1px 0 rgba(255,255,255,.1)}@media (min-width:768px){.navbar-collapse{width:auto;border-top:0;-webkit-box-shadow:none;box-shadow:none}.navbar-collapse.collapse{display:block !important;height:auto !important;padding-bottom:0;overflow:visible !important}.navbar-fixed-top .navbar-collapse{padding-right:0;padding-left:0}}.navbar-fixed-top .navbar-collapse{max-height:340px}@media (max-device-width:480px) and (orientation:landscape){.navbar-fixed-top .navbar-collapse{max-height:200px}}.container>.navbar-collapse,.container>.navbar-header{margin-right:-15px;margin-left:-15px}@media (min-width:768px){.container>.navbar-collapse,.container>.navbar-header{margin-right:0;margin-left:0}}.navbar-fixed-top{position:fixed;right:0;left:0;z-index:1030}@media (min-width:768px){.navbar-fixed-top{border-radius:0}}.navbar-fixed-top{top:0;border-width:0 0 1px}.navbar-brand{float:left;height:50px;padding:15px 15px;font-size:18px;line-height:20px}@media (min-width:768px){.navbar>.container .navbar-brand{margin-left:-15px}}.navbar-toggle{position:relative;float:right;padding:9px 10px;margin-top:8px;margin-right:15px;margin-bottom:8px;background-color:transparent;background-image:none;border:1px solid transparent;border-radius:4px}.navbar-toggle .icon-bar{display:block;width:22px;height:2px;border-radius:1px}.navbar-toggle .icon-bar+.icon-bar{margin-top:4px}@media (min-width:768px){.navbar-toggle{display:none}}.navbar-nav{margin:7.5px -15px}.navbar-nav>li>a{padding-top:10px;padding-bottom:10px;line-height:20px}@media (min-width:768px){.navbar-nav{float:left;margin:0}.navbar-nav>li{float:left}.navbar-nav>li>a{padding-top:15px;padding-bottom:15px}}@media (min-width:768px){.navbar-right{float:right !important;margin-right:-15px}}.navbar-default{background-color:#f8f8f8;border-color:#e7e7e7}.navbar-default .navbar-brand{color:#777}.navbar-default .navbar-nav>li>a{color:#777}.navbar-default .navbar-toggle{border-color:#ddd}.navbar-default .navbar-toggle .icon-bar{background-color:#888}.navbar-default .navbar-collapse{border-color:#e7e7e7}.container:after,.container:before,.nav:after,.nav:before,.navbar-collapse:after,.navbar-collapse:before,.navbar-header:after,.navbar-header:before,.navbar:after,.navbar:before{display:table;content:" "}.container:after,.nav:after,.navbar-collapse:after,.navbar-header:after,.navbar:after{clear:both}@-ms-viewport{width:device-width}.visible-xs{display:none !important}@media (max-width:767px){.visible-xs{display:block !important}}html{height:100%}body{height:100%;padding-top:55px;display:-webkit-box;display:-ms-flexbox;display:flex;text-align:center;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;font-size:16px !important}main{margin:auto;padding:25px;max-width:750px}a:link,a:visited{color:green}.item{padding:10px 0}.item-tag{background-color:green}.navbar-icon{font-size:125%;display:inline-block !important}.navbar.navbar-default{border-top:5px solid green}img{max-width:100%}.fade-in{opacity:0}
.wf-loading p, .wf-loading h1, .wf-loading h2, .wf-loading h3, .wf-loading h4, .wf-loading a {visibility: hidden;}.wf-active  p, .wf-active h1, .wf-active h2, .wf-active h3, .wf-active h4, .wf-active a {visibility: visible;}.wf-inactive    p, .wf-inactive h1, .wf-inactive h2, .wf-inactive h3, .wf-inactive h4, wf-inactive a {visibility: visible;}
</style>

    </head>

    <body bgcolor="#000">
      
      <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KQ3JDPK"
      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
      

        <nav class="navbar navbar-default navbar-fixed-top">

            <div class="container">

                <div class="navbar-header">

                    <a class="navbar-brand visible-xs" href="#">Kubernetes Minikube avec KVM</a>

                    <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>

                </div>

                <div class="collapse navbar-collapse">

                    
                        <ul class="nav navbar-nav">
                            
                                <li><a href="/">Home</a></li>
                            
                                <li><a href="/post/">Posts</a></li>
                            
                                <li><a href="/project/">Projects</a></li>
                            
                        </ul>
                    

                    
                        <ul class="nav navbar-nav navbar-right">
                            
                                <li class="navbar-icon"><a href="/resume/"><i class="fa fa-user"></i></a></li>
                            
                                <li class="navbar-icon"><a href="http://www.google.com/recaptcha/mailhide/d?k=01IIc-s5LNYiS-CG_gthn4PA==&amp;c=r5Ctx8RMDz422qmYESfk1g=="><i class="fa fa-envelope"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://github.com/Geo-Joy"><i class="fa fa-github-alt"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://twitter.com/megeojoy"><i class="fa fa-twitter"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://www.linkedin.com/in/geojoy/"><i class="fa fa-linkedin"></i></a></li>
                            
                        </ul>
                    

                </div>

            </div>

        </nav>


<main class="fade-in">

    <div class="item">

    
    
    

    
      

    <h4><a itemprop="url" href="/post---copy/minikube-avec-kvm/">
      <span itemprop="name">Kubernetes Minikube avec KVM</span>
    </a></h4>

    March 24, 2017
    <h5>Déployer Kubernetes en version locale sous Archlinux avec KVM.</h5>
     <a href="../../../../../tags/linux"><kbd class="item-tag">linux</kbd></a>  <a href="../../../../../tags/kubernetes"><kbd class="item-tag">kubernetes</kbd></a>  <a href="../../../../../tags/docker"><kbd class="item-tag">docker</kbd></a>  <a href="../../../../../tags/devops"><kbd class="item-tag">devops</kbd></a>  <a href="../../../../../tags/golang"><kbd class="item-tag">golang</kbd></a> 

</div>


    <br> <div class="text-justify">

<p><img src="/images/articles/2017/kubernetes.png" alt="Kubernetes" /></p>

<p>&ldquo;<a href="https://kubernetes.io/">Kubernetes</a> est le système Open Source de Google
dédié à la gestion des conteneurs Linux pour des environnements de Cloud privé,
public et hybride.&rdquo; <a href="http://www.lemagit.fr/definition/Kubernetes">source: lemagit</a></p>

<p>Traduire : cela gère vos applications en conteneurs <a href="https://www.docker.com/">Docker</a>
dans un environnement distribué multi-machines.</p>

<blockquote>
<p>Si vous connaissez déjà <a href="http://rancher.com/">Rancher</a>, ils sont concurrents.</p>
</blockquote>

<h2 id="minikube">Minikube</h2>

<p><a href="https://github.com/kubernetes/minikube">Minikube</a> est un outil permettant de
mettre en place rapidement (quand tout va bien) un cluster opérationnel sur
sa machine.</p>

<blockquote>
<p>Je vais traiter de la mise en place d&rsquo;un cluster via <code>KVM</code>, mais il est possible
de le faire avec <code>VirtualBox</code>, mais bon on peut faire sans, donc profitons en !</p>
</blockquote>

<h3 id="vérifications-préliminaires">Vérifications préliminaires</h3>

<p>Il faut tout d&rsquo;abord vérifier que votre machine peut utiliser KVM, pour cela je vous invite à lire la documentation de ma distribution <a href="https://wiki.archlinux.org/index.php/KVM">KVM sur Archlinux</a>.</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ lscpu | grep Virtualisation
Virtualisation :      VT-x</code></pre></div>
<p>La ligne importante est la <code>Virtualisation</code>, indiquant :</p>

<ul>
<li><code>VT-x</code> pour les processeurs <code>intel</code></li>
<li><code>AMD-V</code> pour les processeurs <code>amd</code></li>
</ul>

<blockquote>
<p>Pensez à activer la fonction virtualisation dans votre BIOS.</p>
</blockquote>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ egrep --color<span style="color:#5bc4bf">=</span>auto <span style="color:#48b685">&#39;vmx|svm|0xc0f&#39;</span> /proc/cpuinfo</code></pre></div>
<p>Si une instruction est mise en évidence, c&rsquo;est que votre processeur est
compatible avec la virtualisation matérielle. Si le premier test n&rsquo;affiche pas
de virtualisation, alors que le second affiche les instructions =&gt; Vérifiez
l&rsquo;activation de la virtualisation dans votre BIOS.</p>

<blockquote>
<p>L&rsquo;absence des instructions de virtualisation matérielle aura un effet néfaste
sur la virtualisation, après c&rsquo;est pour un environnement de développement &hellip;</p>
</blockquote>

<h3 id="préparation-de-docker-machine-kvm">Préparation de Docker Machine KVM</h3>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ yaourt -S docker-machine docker-machine-kvm libvirt qemu</code></pre></div>
<ul>
<li><code>docker-machine</code>: outil de gestion des environnements de conteneurs</li>
<li><code>docker-machine-kvm</code>: support KVM de docker-machine</li>
<li><code>libvirt</code>: gestionnaire de virtualisation (qemu, kvm, VirtualBox, etc.)</li>
<li><code>qemu</code>: outil de virtualisation</li>
</ul>

<h4 id="activation-du-daemon-libvirt-au-démarrage">Activation du daemon libvirt au démarrage</h4>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ sudo systemctl enable libvirtd.service
$ sudo systemctl start libvirtd.service</code></pre></div>
<h4 id="configuration-de-réseau-virtuel">Configuration de réseau virtuel</h4>

<p>Il faut vérifier que les réseaux virtuels existent.</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ sudo virsh net-list --all
 Nom                  État      Démarrage automatique Persistent
----------------------------------------------------------
 docker-machines      actif      yes           yes</code></pre></div>
<p>Par défaut, c&rsquo;est le réseau <code>default</code> qui est utilisé par <code>minikube</code>. Dans mon
cas, il n&rsquo;était pas créé. Pour cela, il faut utiliser la spécification fournit
par qemu pour initialiser le réseau <code>default</code>.</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ sudo virsh net-create --file <span style="color:#48b685">&#39;/etc/libvirt/qemu/networks/default.xml&#39;</span>
$ sudo virsh net-start --network default
Réseau default démarré

$ sudo virsh net-autostart --network default
Réseau default marqué en démarrage automatique

$ sudo virsh net-list --all
 Nom                  État      Démarrage automatique Persistent
lastmod: <span style="color:#f99b15">2017</span>-03-28T20:05:06+02:00
----------------------------------------------------------
 default              actif      yes           yes
 docker-machines      actif      yes           yes</code></pre></div>
<p>Le réseau <code>default</code> est maintenant opérationnel et configuré en démarrage
automatique lors du lancement de <code>virtd</code>.</p>

<h4 id="permissions-utilisateur">Permissions utilisateur</h4>

<p>Il faut ajouter votre utilisateur courant à certains groupes pour éviter de tout faire en root.</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ sudo usermod -G docker,kvm,libvirt -a zenithar
$ newgrp</code></pre></div>
<p>Petite astuce, pensez à vérifier le groupe du fichier <code>/dev/kvm</code>, et à le
changer si besoin.</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ ls -lsa /dev/kvm
<span style="color:#f99b15">0</span> crw-rw----+ <span style="color:#f99b15">1</span> root root <span style="color:#f99b15">10</span>, <span style="color:#f99b15">232</span> <span style="color:#f99b15">24</span> mars  <span style="color:#f99b15">19</span>:04 /dev/kvm
$ sudo chgrp kvm /dev/kvm</code></pre></div>
<h4 id="premier-test">Premier test</h4>

<p>Normalement, si tout va bien (pour reprendre les expressions du boulot), tout
marche !</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ docker-machine create -d kvm myengine0
Running pre-create checks...
Creating machine...
<span style="color:#5bc4bf">(</span>myengine0<span style="color:#5bc4bf">)</span> Copying /home/zenithar/.docker/machine/cache/boot2docker.iso to /home/zenithar/.docker/machine/machines/myengine0/boot2docker.iso...
Waiting <span style="color:#815ba4">for</span> machine to be running, this may take a few minutes...
Detecting operating system of created instance...
Waiting <span style="color:#815ba4">for</span> SSH to be available...
Detecting the provisioner...
Provisioning with boot2docker...
Copying certs to the local machine directory...
Copying certs to the remote machine...
Setting Docker configuration on the remote daemon...
Checking connection to Docker...
Docker is up and running!
To see how to connect your Docker Client to the Docker Engine running on this virtual machine, run: docker-machine env myengine0
Running pre-create checks...
Creating machine...
<span style="color:#5bc4bf">(</span>myengine0<span style="color:#5bc4bf">)</span> Copying /home/zenithar/.docker/machine/cache/boot2docker.iso to /home/zenithar/.docker/machine/machines/myengine0/boot2docker.iso...
Waiting <span style="color:#815ba4">for</span> machine to be running, this may take a few minutes...
Detecting operating system of created instance...
Waiting <span style="color:#815ba4">for</span> SSH to be available...
Detecting the provisioner...
Provisioning with boot2docker...
Copying certs to the local machine directory...
Copying certs to the remote machine...
Setting Docker configuration on the remote daemon...
Checking connection to Docker...
Docker is up and running!
To see how to connect your Docker Client to the Docker Engine running on this virtual machine, run: docker-machine env myengine0</code></pre></div>
<p>Il se peut que le privisioning ne fonctionne pas bien, c&rsquo;est souvent un problème
 de certificats, pour cela vous devez les regénerer.</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ docker-machine regenerate-certs myengine0</code></pre></div>
<p>Pour pouvoir utiliser le client Docker avec le service docker s&rsquo;executant dans
la VM, il faut mettre en place des variables d&rsquo;environnements (<a href="https://12factor.net">12 Factor Application</a> tout ça, tout ça !).</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ docker-machine env myengine0
export <span style="color:#ef6155">DOCKER_TLS_VERIFY</span><span style="color:#5bc4bf">=</span><span style="color:#48b685">&#34;1&#34;</span>
export <span style="color:#ef6155">DOCKER_HOST</span><span style="color:#5bc4bf">=</span><span style="color:#48b685">&#34;tcp://192.168.42.125:2376&#34;</span>
export <span style="color:#ef6155">DOCKER_CERT_PATH</span><span style="color:#5bc4bf">=</span><span style="color:#48b685">&#34;/home/zenithar/.docker/machine/machines/myengine0&#34;</span>
export <span style="color:#ef6155">DOCKER_MACHINE_NAME</span><span style="color:#5bc4bf">=</span><span style="color:#48b685">&#34;myengine0&#34;</span>
$ eval <span style="color:#815ba4">$(</span>docker-machine env myengine0<span style="color:#815ba4">)</span></code></pre></div>
<p>Vous pouvez utiliser docker comme vous le faite d&rsquo;habitude, mais les conteneurs
seront dans la VM gérée par KVM.</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ eval <span style="color:#815ba4">$(</span>docker-machine env myengine0<span style="color:#815ba4">)</span>
$ docker pull alpine:edge  
edge: Pulling from library/alpine
71c5a0cc58e4: Pull complete
Digest: sha256:99588bc8883c955c157d18fc3eaa4a3c1400c223e6c7cabca5f600a3e9f8d5cd
Status: Downloaded newer image <span style="color:#815ba4">for</span> alpine:edge
$ docker run -ti alpine:edge /bin/sh  
/ <span style="color:#776e71">#
</span><span style="color:#776e71"></span>/ <span style="color:#776e71"># cat /proc/version
</span><span style="color:#776e71"></span>Linux version <span style="color:#f99b15">4</span>.4.52-boot2docker <span style="color:#5bc4bf">(</span>root@ed11f485244a<span style="color:#5bc4bf">)</span> <span style="color:#5bc4bf">(</span>gcc version <span style="color:#f99b15">4</span>.9.2 <span style="color:#5bc4bf">(</span>Debian <span style="color:#f99b15">4</span>.9.2-10<span style="color:#5bc4bf">)</span> <span style="color:#5bc4bf">)</span> <span style="color:#776e71">#1 SMP Wed Mar 1 23:41:46 UTC 2017
</span><span style="color:#776e71"></span>/ #</code></pre></div>
<blockquote>
<p>Le shell est ouvert dans un conteneur docker géré par une VM géré par KVM.</p>
</blockquote>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ docker-machine ls
NAME        ACTIVE   DRIVER   STATE     URL                         SWARM   DOCKER        ERRORS
myengine0   *        kvm      Running   tcp://192.168.42.125:2376           v17.03.0-ce</code></pre></div>
<p><a href="https://docs.docker.com/machine/overview/">Docker Machine</a> permet de piloter à distance des <a href="https://docs.docker.com/machine/drivers/os-base/">hyperviseurs différents</a> (AWS, Hyper-V, OpenStack, VirtualBox, KVM, VMWare, etc.)</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ docker-machine rm myengine0      
About to remove myengine0
WARNING: This action will delete both local reference and remote instance.
Are you sure? <span style="color:#5bc4bf">(</span>y/n<span style="color:#5bc4bf">)</span>: y
Successfully removed myengine0</code></pre></div>
<p>A partir de là, la virtualisation avec KVM fonctionne, il suffit de lancer l&rsquo;installation de minikube.</p>

<h3 id="installation-de-minikube">Installation de minikube</h3>

<p>Il faut installer quelques outils :</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ yaourt -S minikube kubectl-bin</code></pre></div>
<ul>
<li><code>minikube</code>: outil d&rsquo;installation du cluster Kubernetes local;</li>
<li><code>kubectl-bin</code>: outil d&rsquo;administration client du cluster Kubernetes.</li>
</ul>

<p>Commençons par préparer le cluster Kubernetes :</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ minikube start --vm-driver kvm
Starting local Kubernetes cluster...
Starting VM...
SSH-ing files into VM...
Setting up certs...
Starting cluster components...
Connecting to cluster...
Setting up kubeconfig...
Kubectl is now configured to use the cluster.</code></pre></div>
<p>Le cluster est opérationnel !</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ minikube status
minikubeVM: Running
localkube: Running</code></pre></div>
<p>Vérifions auprès de virsh.</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ sudo virsh list --all
 ID    Nom                            État
----------------------------------------------------
 <span style="color:#f99b15">2</span>     minikube                       en cours d exécution</code></pre></div>
<blockquote>
<p>Yatta !</p>
</blockquote>

<h4 id="lancement-du-dashboard">Lancement du dashboard</h4>

<p>Le dashboard présente les informations du cluster sous la forme d&rsquo;un site
internet Material Design (Google oblige &hellip;), mais personnellement il vaut
mieux passer du temps à comprendre les concepts de Kubernetes et les manipuler
par le client, plutôt que d&rsquo;attendre d&rsquo;avoir une IHM web complète.</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ minikube dashboard</code></pre></div>
<h4 id="premier-déploiement">Premier déploiement</h4>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ kubectl run hello-minikube --image<span style="color:#5bc4bf">=</span>gcr.io/google_containers/echoserver:1.4 --port<span style="color:#5bc4bf">=</span><span style="color:#f99b15">8080</span>
deployment <span style="color:#48b685">&#34;hello-minikube&#34;</span> created
$ kubectl expose deployment hello-minikube --type<span style="color:#5bc4bf">=</span>NodePort
service <span style="color:#48b685">&#34;hello-minikube&#34;</span> exposed</code></pre></div>
<p>Il faut attendre que le pod soit démarré :</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ kubectl get pod
NAME                              READY     STATUS    RESTARTS   AGE
hello-minikube-3015430129-26987   <span style="color:#f99b15">1</span>/1       Running   <span style="color:#f99b15">0</span>          26s</code></pre></div>
<p>Maintenant on peut faire un <code>curl</code> sur le service :</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ curl <span style="color:#815ba4">$(</span>minikube service hello-minikube --url<span style="color:#815ba4">)</span>
CLIENT VALUES:
<span style="color:#ef6155">client_address</span><span style="color:#5bc4bf">=</span><span style="color:#f99b15">172</span>.17.0.1
<span style="color:#ef6155">command</span><span style="color:#5bc4bf">=</span>GET
real <span style="color:#ef6155">path</span><span style="color:#5bc4bf">=</span>/
<span style="color:#ef6155">query</span><span style="color:#5bc4bf">=</span>nil
<span style="color:#ef6155">request_version</span><span style="color:#5bc4bf">=</span><span style="color:#f99b15">1</span>.1
<span style="color:#ef6155">request_uri</span><span style="color:#5bc4bf">=</span>http://192.168.42.63:8080/

SERVER VALUES:
<span style="color:#ef6155">server_version</span><span style="color:#5bc4bf">=</span>nginx: <span style="color:#f99b15">1</span>.10.0 - lua: <span style="color:#f99b15">10001</span>

HEADERS RECEIVED:
<span style="color:#ef6155">accept</span><span style="color:#5bc4bf">=</span>*/*
<span style="color:#ef6155">host</span><span style="color:#5bc4bf">=</span><span style="color:#f99b15">192</span>.168.42.63:30627
user-agent<span style="color:#5bc4bf">=</span>curl/7.53.1
BODY:
-no body in request-%</code></pre></div>
<blockquote>
<p>Voilà tout fonctionne !</p>
</blockquote>

<h4 id="pour-arréter-kubernetes">Pour arréter Kubernetes</h4>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ minikube stop</code></pre></div></div>

    
    

    
        <h4 class="page-header">Related</h4>
        
          <div class="item">

    
    
    

    
      

    <h4><a itemprop="url" href="/post/2018/01/17/test-description/">
      <span itemprop="name">Test1</span>
    </a></h4>

    January 17, 2018
    <h5>January 17, 2018</h5>
     <a href="../../../../../tags/python"><kbd class="item-tag">python</kbd></a>  <a href="../../../../../tags/mopidy"><kbd class="item-tag">mopidy</kbd></a>  <a href="../../../../../tags/raspberry"><kbd class="item-tag">raspberry</kbd></a>  <a href="../../../../../tags/linux"><kbd class="item-tag">linux</kbd></a>  <a href="../../../../../tags/spotify"><kbd class="item-tag">spotify</kbd></a> 

</div>

        
    

    

</main>

        <footer>

            <p class="copyright text-muted">Geo Joy &copy; All rights reserved. Powered by <a href="https://gohugo.io">Hugo</a> and <a href="https://github.com/calintat/minimal">Minimal</a> hosted on <a href="https://github.com/Geo-Joy/geo-joy.github.io">Github</a></p>

        </footer>
        
       <script async="" src="http://geojoy.me/js/main.js"></script>

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KQ3JDPK');</script>


    </body>

</html>

