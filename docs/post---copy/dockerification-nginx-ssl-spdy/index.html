<!DOCTYPE html>
<html lang="en-us" class="wf-loading">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />

        <meta name="HandheldFriendly" content="True" />
        <meta name="MobileOptimized" content="320" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <link rel="preload" href="http://geojoy.me/js/main.js" as="script" />
        <link rel="preload" href="http://geojoy.me/css/main.css" as="style" />

        <title>Dockerification : NGINX &#43; SSL &#43; SPDY</title>
        <meta name="generator" content="Hugo 0.32.4" />
        
        <link rel="preconnect" href="https://ajax.googleapis.com/" crossorigin>
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
        <meta property="og:title" content="Dockerification : NGINX &#43; SSL &#43; SPDY" />
<meta property="og:description" content="Création d&#39;un container docker contenant NGiNX configuré pour du SSL / SPDY." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://geojoy.me/post---copy/dockerification-nginx-ssl-spdy/" />



<meta property="article:published_time" content="2014-03-10T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2017-03-01T11:27:29&#43;01:00"/>











    
        <meta property="og:type" content="article" />
        <meta property="og:article:published_time" content="2014-03-10T00:00:00Z" />
        <meta property="og:article:tag" content="devops" />
        <meta property="og:article:tag" content="lxc" />
        <meta property="og:article:tag" content="docker" />
        <meta property="og:article:tag" content="nginx" />
        <meta property="og:article:tag" content="spdy" />
        
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@megeojoy" />
        <meta name="twitter:creator" content="@megeojoy" />
        <meta name="twitter:title" content="Dockerification : NGINX &#43; SSL &#43; SPDY" />
        <meta name="twitter:description" content="Création d&#39;un container docker contenant NGiNX configuré pour du SSL / SPDY." />
        <meta name="twitter:url" content="http://geojoy.me/post---copy/dockerification-nginx-ssl-spdy/" />
        <meta name="twitter:image" content="http://geojoy.me/images/docker-1.png">
    

    
        <meta name="p:domain_verify" content="58lHJFznHgioHOIv2NvLfobc8XEUUZSKm016uFFO4vE"/>
    

    
    <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "Geo Joy",
      "url": "http://geojoy.me",
      "sameAs": [
        "https://twitter.com/megeojoy",
        "https://www.linkedin.com/in/geojoy/",
        "https://github.com/Geo-Joy",
      ],
      "image": {
        "@type": "ImageObject",
        "url": "https://geojoy.me/images/avatar.jpg",
        "height": 80,
        "width": 80
      }
    }
    </script>

    <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Organization",
      "@id": "http://geojoy.me",
      "name": "Geo&#39;z Blog",
      "url": "http://geojoy.me",
      "logo": {
        "@type": "ImageObject",
        "url": "https://geojoy.me/images/avatar.jpg",
        "height": 80,
        "width": 80
      }
    }
    </script>

    <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "WebSite",
      "url": "http://geojoy.me",
      "name": "Geo&#39;z Blog",
      "author": {
        "@type": "Person",
        "name": "Geo Joy"
      },
      "description": ""
    }
    </script>

      
      <script type="application/ld+json">
      {
          "@context": "http://schema.org",
          "@type": "BlogPosting",
          "headline": "Dockerification : NGINX &#43; SSL &#43; SPDY",
          "description": "Création d&#39;un container docker contenant NGiNX configuré pour du SSL / SPDY.",
          "author": {
              "@type": "Person",
              "name": "Geo Joy"
          },
          "publisher": {
              "@type": "Organization",
              "name": "Geo&#39;z Blog",
              "logo": "https://geojoy.me/images/avatar.jpg"
          },
          "image": {
            "@type": "ImageObject",
            "url": "http://geojoy.me/images/docker-1.png",
            "height": 133,
            "width": 200
          },
          "datePublished": "2014-03-10",
          "dateModified": "2017-03-01",
          "wordCount": 622
          ,
          "keywords": ["devops","lxc","docker","nginx","spdy"] 
      }
    </script>
  

    <style>
body{margin:0}main,nav{display:block}a{background-color:transparent}h1{margin:.67em 0;font-size:2em}img{border:0}code,kbd{font-family:monospace,monospace;font-size:1em}button{margin:0;font:inherit;color:inherit}button{overflow:visible}button{text-transform:none}button{-webkit-appearance:button}button::-moz-focus-inner{padding:0;border:0}*{-webkit-box-sizing:border-box;box-sizing:border-box}:after,:before{-webkit-box-sizing:border-box;box-sizing:border-box}html{font-size:10px}body{font-family:"Raleway",Helvetica,Arial,sans-serif;font-size:14px;line-height:1.42857143;color:#333;background-color:#fff}button{font-family:inherit;font-size:inherit;line-height:inherit}a{color:#337ab7;text-decoration:none}img{vertical-align:middle}h1,h4,h5{font-family:inherit;font-weight:500;line-height:1.1;color:inherit}h1{margin-top:20px;margin-bottom:10px}h4,h5{margin-top:10px;margin-bottom:10px}h1{font-size:36px}h4{font-size:18px}h5{font-size:14px}p{margin:0 0 10px}.text-justify{text-align:justify}ul{margin-top:0;margin-bottom:10px}blockquote{padding:10px 20px;margin:0 0 20px;font-size:17.5px;border-left:5px solid #eee}blockquote p:last-child{margin-bottom:0}code,kbd{font-family:Menlo,Monaco,Consolas,"Courier New",monospace}code{padding:2px 4px;font-size:90%;color:#c7254e;background-color:#f9f2f4;border-radius:4px}kbd{padding:2px 4px;font-size:90%;color:#fff;background-color:#333;border-radius:3px;-webkit-box-shadow:inset 0 -1px 0 rgba(0,0,0,.25);box-shadow:inset 0 -1px 0 rgba(0,0,0,.25)}.container{padding-right:15px;padding-left:15px;margin-right:auto;margin-left:auto}@media (min-width:768px){.container{width:750px}}@media (min-width:992px){.container{width:970px}}@media (min-width:1200px){.container{width:1170px}}.collapse{display:none}.nav{padding-left:0;margin-bottom:0;list-style:none}.nav>li{position:relative;display:block}.nav>li>a{position:relative;display:block;padding:10px 15px}.navbar{position:relative;min-height:50px;margin-bottom:20px;border:1px solid transparent}@media (min-width:768px){.navbar{border-radius:4px}}@media (min-width:768px){.navbar-header{float:left}}.navbar-collapse{padding-right:15px;padding-left:15px;overflow-x:visible;-webkit-overflow-scrolling:touch;border-top:1px solid transparent;-webkit-box-shadow:inset 0 1px 0 rgba(255,255,255,.1);box-shadow:inset 0 1px 0 rgba(255,255,255,.1)}@media (min-width:768px){.navbar-collapse{width:auto;border-top:0;-webkit-box-shadow:none;box-shadow:none}.navbar-collapse.collapse{display:block !important;height:auto !important;padding-bottom:0;overflow:visible !important}.navbar-fixed-top .navbar-collapse{padding-right:0;padding-left:0}}.navbar-fixed-top .navbar-collapse{max-height:340px}@media (max-device-width:480px) and (orientation:landscape){.navbar-fixed-top .navbar-collapse{max-height:200px}}.container>.navbar-collapse,.container>.navbar-header{margin-right:-15px;margin-left:-15px}@media (min-width:768px){.container>.navbar-collapse,.container>.navbar-header{margin-right:0;margin-left:0}}.navbar-fixed-top{position:fixed;right:0;left:0;z-index:1030}@media (min-width:768px){.navbar-fixed-top{border-radius:0}}.navbar-fixed-top{top:0;border-width:0 0 1px}.navbar-brand{float:left;height:50px;padding:15px 15px;font-size:18px;line-height:20px}@media (min-width:768px){.navbar>.container .navbar-brand{margin-left:-15px}}.navbar-toggle{position:relative;float:right;padding:9px 10px;margin-top:8px;margin-right:15px;margin-bottom:8px;background-color:transparent;background-image:none;border:1px solid transparent;border-radius:4px}.navbar-toggle .icon-bar{display:block;width:22px;height:2px;border-radius:1px}.navbar-toggle .icon-bar+.icon-bar{margin-top:4px}@media (min-width:768px){.navbar-toggle{display:none}}.navbar-nav{margin:7.5px -15px}.navbar-nav>li>a{padding-top:10px;padding-bottom:10px;line-height:20px}@media (min-width:768px){.navbar-nav{float:left;margin:0}.navbar-nav>li{float:left}.navbar-nav>li>a{padding-top:15px;padding-bottom:15px}}@media (min-width:768px){.navbar-right{float:right !important;margin-right:-15px}}.navbar-default{background-color:#f8f8f8;border-color:#e7e7e7}.navbar-default .navbar-brand{color:#777}.navbar-default .navbar-nav>li>a{color:#777}.navbar-default .navbar-toggle{border-color:#ddd}.navbar-default .navbar-toggle .icon-bar{background-color:#888}.navbar-default .navbar-collapse{border-color:#e7e7e7}.container:after,.container:before,.nav:after,.nav:before,.navbar-collapse:after,.navbar-collapse:before,.navbar-header:after,.navbar-header:before,.navbar:after,.navbar:before{display:table;content:" "}.container:after,.nav:after,.navbar-collapse:after,.navbar-header:after,.navbar:after{clear:both}@-ms-viewport{width:device-width}.visible-xs{display:none !important}@media (max-width:767px){.visible-xs{display:block !important}}html{height:100%}body{height:100%;padding-top:55px;display:-webkit-box;display:-ms-flexbox;display:flex;text-align:center;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;font-size:16px !important}main{margin:auto;padding:25px;max-width:750px}a:link,a:visited{color:green}.item{padding:10px 0}.item-tag{background-color:green}.navbar-icon{font-size:125%;display:inline-block !important}.navbar.navbar-default{border-top:5px solid green}img{max-width:100%}.fade-in{opacity:0}
.wf-loading p, .wf-loading h1, .wf-loading h2, .wf-loading h3, .wf-loading h4, .wf-loading a {visibility: hidden;}.wf-active  p, .wf-active h1, .wf-active h2, .wf-active h3, .wf-active h4, .wf-active a {visibility: visible;}.wf-inactive    p, .wf-inactive h1, .wf-inactive h2, .wf-inactive h3, .wf-inactive h4, wf-inactive a {visibility: visible;}
</style>

    </head>

    <body bgcolor="#000">
      
      <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KQ3JDPK"
      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
      

        <nav class="navbar navbar-default navbar-fixed-top">

            <div class="container">

                <div class="navbar-header">

                    <a class="navbar-brand visible-xs" href="#">Dockerification : NGINX &#43; SSL &#43; SPDY</a>

                    <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>

                </div>

                <div class="collapse navbar-collapse">

                    
                        <ul class="nav navbar-nav">
                            
                                <li><a href="/">Home</a></li>
                            
                                <li><a href="/post/">Posts</a></li>
                            
                                <li><a href="/project/">Projects</a></li>
                            
                        </ul>
                    

                    
                        <ul class="nav navbar-nav navbar-right">
                            
                                <li class="navbar-icon"><a href="/resume/"><i class="fa fa-user"></i></a></li>
                            
                                <li class="navbar-icon"><a href="http://www.google.com/recaptcha/mailhide/d?k=01IIc-s5LNYiS-CG_gthn4PA==&amp;c=r5Ctx8RMDz422qmYESfk1g=="><i class="fa fa-envelope"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://github.com/Geo-Joy"><i class="fa fa-github-alt"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://twitter.com/megeojoy"><i class="fa fa-twitter"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://www.linkedin.com/in/geojoy/"><i class="fa fa-linkedin"></i></a></li>
                            
                        </ul>
                    

                </div>

            </div>

        </nav>


<main class="fade-in">

    <div class="item">

    
    
    

    
      

    <h4><a itemprop="url" href="/post---copy/dockerification-nginx-ssl-spdy/">
      <span itemprop="name">Dockerification : NGINX &#43; SSL &#43; SPDY</span>
    </a></h4>

    March 10, 2014
    <h5>Création d&#39;un container docker contenant NGiNX configuré pour du SSL / SPDY.</h5>
     <a href="../../../../../tags/devops"><kbd class="item-tag">devops</kbd></a>  <a href="../../../../../tags/lxc"><kbd class="item-tag">lxc</kbd></a>  <a href="../../../../../tags/docker"><kbd class="item-tag">docker</kbd></a>  <a href="../../../../../tags/nginx"><kbd class="item-tag">nginx</kbd></a>  <a href="../../../../../tags/spdy"><kbd class="item-tag">spdy</kbd></a> 

</div>


    <br> <div class="text-justify">

<p>On entend beaucoup parler de <a href="https://www.docker.io/">Docker</a> en ce moment que ce soit sur les réseaux sociaux modernes ou plus anciens. Il est clair que cela buzz pas mal autour de cette technologie basé sur <a href="http://linuxcontainers.org/">LXC</a> (LinuX Container), sorte de super chroot portable.</p>

<p>Nous allons mettre en oeuvre un container docker contenant NGiNX configuré pour faire du SSL/SPDY. NGiNX sera compilé à partir des sources depuis une image de construction, puis exporté sous la forme d&rsquo;un container docker allégé.</p>

<h2 id="avant-de-commencer">Avant de commencer</h2>

<h3 id="qu-est-ce-qu-un-chroot">Qu&rsquo;est ce qu&rsquo;un chroot ?</h3>

<p>Chroot est une commande UNIX, contraction de <code>change root</code>, permettant pour un processus donné de virtualiser la racine <code>/</code>. En effet pour le processus lancé, le <code>/</code> sera un répertoire défini.</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">#&gt; chroot &lt;path&gt; &lt;command&gt;</code></pre></div>
<p>La commande sera executée dans un environnement où la racine du système de fichier sera le <code>path</code> indiqué. Vous pouvez grâce à cette commande restreindre les fichiers accessibles par le processus.</p>

<p>Il existe d&rsquo;autres types de cloisonnements utilisés notamment sur les systèmes BSD.</p>

<h3 id="qu-est-ce-qu-une-jail">Qu&rsquo;est-ce qu&rsquo;une jail ?</h3>

<p>Une jail (prison en français) est une amélioration du chroot, mais avec un cloisonnement des ressources allouées au processus. Une jail va limiter l&rsquo;accès FS, mais aussi la mémoire utilisable, et bien d&rsquo;autres choses.</p>

<p>Avec l&rsquo;arrivée des kernels Linux récent (&gt;3.8), nous avons vu l&rsquo;apparition d&rsquo;un nouveau type de conteneur, cette fois généralisé aux Linux : LXC.</p>

<h3 id="qu-est-ce-que-lxc">Qu&rsquo;est ce que LXC ?</h3>

<p><code>LinuX Container</code> est une technologie de cloisonnement de contexte type jail, ce n&rsquo;est pas réellement de la virtualisation, ni encore moins de l&rsquo;émulation. Mais simplement et purement une séparation de contexte d&rsquo;exécution à l&rsquo;aide d&rsquo;espace de noms (cgroups). Ils sont utilisés pour éxecuter des environnements Linux isolés des uns des autres dans des conteneurs partageant le même noyau.</p>

<h3 id="qu-est-ce-que-docker">Qu&rsquo;est ce que Docker ?</h3>

<p>Docker est un outil <code>user-land</code> pour gérer les conteneurs LXC.</p>

<h2 id="création-du-conteneur-docker">Création du conteneur Docker</h2>

<p>Afin de pouvoir créer un conteneur léger, je vais donc créer deux conteneurs :</p>

<ul>
<li>Un conteneur de création : utilisé pour compiler et créer l&rsquo;environnement d&rsquo;éxecution allégé.</li>
<li>Un conteneur réutilisable : contenant l&rsquo;environnement d&rsquo;éxecution précédemment crée.</li>
</ul>

<h3 id="conteneur-de-création">Conteneur de création</h3>

<p>Ce conteneur est utilisé pour générer le binaire du programme à isoler. J&rsquo;ai choisi de prendre comme exemple NGiNX, un serveur web léger et puissant.</p>

<p>Nous allons procéder à la compilation du serveur, et afin de reduire les librairies, nous allons compiler certaines de celles-ci en statique (ZLIB, OPENSSL, PCRE).</p>

<code data-gist-id="9209968"></code>


<p>Pour construire l&rsquo;image il suffit de lancer la commande suivante :</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$&gt; docker build -t zenithar/nano-nginx-builder .</code></pre></div>
<h3 id="conteneur-réutilisable">Conteneur réutilisable</h3>

<p>Il faut a présent extraire le fichier rootfs.tar de l&rsquo;image qui a été créée. Pour cela nous allons exécuter la commande suivante :</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$&gt; docker run zenithar/nano-nginx-builder cat /rootfs.tar &gt; rootfs.tar</code></pre></div>
<p>Cette commande va démarrer le conteneur précedemment construit puis extraire via une redirection de flux, le fichier rootfs.tar. On aurait pu aussi créer un volume puis déplacer le fichier vers le volume pour le récupérer.</p>

<code data-gist-id="9465539"></code>


<p>Et voilà ! Notre image nano NGiNX est prête.</p>

<h2 id="premier-lancement">Premier lancement</h2>

<p>L&rsquo;image est maintenant prête a être executée dans le conteneur docker. Cette image est allégée au possible, et peut être executée sur toutes les plateformes supportées par docker.</p>

<p>L&rsquo;image créée précedemment exporte 4 volumes :</p>

<ul>
<li>&rdquo;/var/log/nginx&rdquo;: espace de stockage pour les logs</li>
<li>&rdquo;/www&rdquo; : espace de stockage pour les sites</li>
<li>&rdquo;/etc/nginx/sites-available&rdquo; : pour la configuration des vhosts</li>
<li>&rdquo;/etc/nginx/ssl&rdquo; : pour les certificats</li>
</ul>

<p>Vous pouvez vous créer une images contenant la configuration commune (SSL).</p>

<p>Le lancement du conteneur sur fait à l&rsquo;aide de la commande docker (comme toujours) :</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$&gt; docker run -t zenithar/nano-nginx -v /var/log/nginx:/var/log/nginx -v /srv/www:/www -v /srv/vhosts:/etc/nginx/sites-available -v /srv/ssl:/etc/nginx/ssl -p <span style="color:#f99b15">80</span>:80 -p <span style="color:#f99b15">443</span>:443</code></pre></div>
<p>Cette commande va lancer le serveur NGiNX (/usr/sbin/nginx), rediriger les ports <sup>80</sup>&frasl;<sub>443</sub> du conteneur vers l&rsquo;hôte, et monter les volumes.</p>

<p>Vous avez &ldquo;contenarisé&rdquo; nginx !</p>
</div>

    
    

    

    

</main>

        <footer>

            <p class="copyright text-muted">Geo Joy &copy; All rights reserved. Powered by <a href="https://gohugo.io">Hugo</a> and <a href="https://github.com/calintat/minimal">Minimal</a> hosted on <a href="https://github.com/Geo-Joy/geo-joy.github.io">Github</a></p>

        </footer>
        
       <script async="" src="http://geojoy.me/js/main.js"></script>

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KQ3JDPK');</script>


    </body>

</html>

